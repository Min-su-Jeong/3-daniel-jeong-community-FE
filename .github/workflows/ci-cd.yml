name: Node.js CI/CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [19.x, 20.x, 21.x, 22.x]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm install
      - name: Run tests
        run: npm test

  build-and-push-image:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Create ECR Repository if not exists
        run: |
          set +x
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          aws ecr describe-repositories --repository-names community-frontend --region ${{ secrets.AWS_REGION }} 2>/dev/null || \
          aws ecr create-repository \
            --repository-name community-frontend \
            --image-scanning-configuration scanOnPush=true \
            --encryption-configuration encryptionType=AES256 \
            --region ${{ secrets.AWS_REGION }}

      - name: Update Parameter Store with ECR Image URI
        run: |
          set +x
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          ECR_URI=$(aws ecr describe-repositories --repository-names community-frontend --query 'repositories[0].repositoryUri' --output text --region ${{ secrets.AWS_REGION }})
          echo "::add-mask::$ECR_URI"
          ECR_FRONTEND_IMAGE="${ECR_URI}:latest"
          echo "::add-mask::$ECR_FRONTEND_IMAGE"
          aws ssm put-parameter \
            --name "/community/ecr_frontend_image" \
            --value "$ECR_FRONTEND_IMAGE" \
            --type "String" \
            --overwrite \
            --region ${{ secrets.AWS_REGION }} || echo "Parameter Store update failed, but continuing..."

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Build and Push Docker Image to ECR
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ steps.login-ecr.outputs.registry }}/community-frontend:latest
          platforms: linux/arm64

  deploy:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Check if Docker is installed
        run: |
          set +x
          echo "::add-mask::${{ secrets.EC2_INSTANCE_ID }}"
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["command -v docker >/dev/null && echo \"true\" || echo \"false\""]' \
            --output text \
            --query 'Command.CommandId')
          echo "::add-mask::$COMMAND_ID"
          
          echo "Waiting for command to complete..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }} >/dev/null 2>&1
          
          DOCKER_EXISTS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text | tr -d '\r\n')
          
          if [ "$DOCKER_EXISTS" != "true" ]; then
            echo "Error: Docker is not installed on the EC2 instance"
            exit 1
          fi
          
          echo "Docker is installed"

      - name: Check if Docker Network Exists
        run: |
          set +x
          echo "::add-mask::${{ secrets.EC2_INSTANCE_ID }}"
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=["if ! sudo docker network inspect community-network >/dev/null 2>&1; then sudo docker network create community-network && echo \"Created docker network: community-network\"; else echo \"Docker network community-network already exists\"; fi"]' \
            --output text \
            --query 'Command.CommandId')
          echo "::add-mask::$COMMAND_ID"
          
          echo "Waiting for network setup to complete..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }} >/dev/null 2>&1
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text)
          
          echo "$OUTPUT" | sed 's/password[^[:space:]]*/[REDACTED]/gi' | sed 's/token[^[:space:]]*/[REDACTED]/gi' | sed 's/key[^[:space:]]*/[REDACTED]/gi' | sed 's/secret[^[:space:]]*/[REDACTED]/gi'

      - name: Login to ECR on EC2
        run: |
          set +x
          echo "::add-mask::${{ secrets.EC2_INSTANCE_ID }}"
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          ECR_REGISTRY=$(aws ecr describe-repositories --repository-names community-frontend --query 'repositories[0].repositoryUri' --output text --region ${{ secrets.AWS_REGION }} | sed 's|/.*||')
          echo "::add-mask::$ECR_REGISTRY"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[\"aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | sudo docker login --username AWS --password-stdin $ECR_REGISTRY\"]" \
            --output text \
            --query 'Command.CommandId')
          echo "::add-mask::$COMMAND_ID"
          
          echo "Waiting for ECR login to complete..."
          for i in {1..30}; do
            STATUS=$(aws ssm get-command-invocation \
              --command-id $COMMAND_ID \
              --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
              --query 'Status' \
              --output text)
            
            if [ "$STATUS" = "Success" ] || [ "$STATUS" = "Failed" ] || [ "$STATUS" = "Cancelled" ] || [ "$STATUS" = "TimedOut" ]; then
              break
            fi
            sleep 2
          done
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Status' \
            --output text)
          
          if [ "$STATUS" != "Success" ]; then
            exit 1
          fi
          
          echo "ECR login successful"

      - name: Deploy to EC2 via Docker Compose
        run: |
          set +x
          echo "::add-mask::${{ secrets.EC2_INSTANCE_ID }}"
          echo "::add-mask::${{ secrets.AWS_REGION }}"
          ECR_FRONTEND_IMAGE=$(aws ssm get-parameter --name "/community/ecr_frontend_image" --query 'Parameter.Value' --output text --region ${{ secrets.AWS_REGION }})
          echo "::add-mask::$ECR_FRONTEND_IMAGE"
          
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids ${{ secrets.EC2_INSTANCE_ID }} \
            --document-name "AWS-RunShellScript" \
            --parameters "commands=[\"cd /home/ubuntu/prod && export ECR_FRONTEND_IMAGE=$ECR_FRONTEND_IMAGE && sudo -E docker compose pull frontend && sudo -E docker compose up -d frontend\"]" \
            --output text \
            --query 'Command.CommandId')
          echo "::add-mask::$COMMAND_ID"
          
          echo "Waiting for deployment to complete..."
          aws ssm wait command-executed \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --region ${{ secrets.AWS_REGION }} >/dev/null 2>&1
          
          OUTPUT=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardOutputContent' \
            --output text)
          
          ERROR=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'StandardErrorContent' \
            --output text)
          
          STATUS=$(aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id ${{ secrets.EC2_INSTANCE_ID }} \
            --query 'Status' \
            --output text)
          
          echo "=== Deployment Output ==="
          echo "$OUTPUT" | sed 's/password[^[:space:]]*/[REDACTED]/gi' | sed 's/token[^[:space:]]*/[REDACTED]/gi' | sed 's/key[^[:space:]]*/[REDACTED]/gi' | sed 's/secret[^[:space:]]*/[REDACTED]/gi' | sed 's/Authorization[^[:space:]]*/[REDACTED]/gi'
          
          if [ -n "$ERROR" ] && [ "$ERROR" != "None" ]; then
            echo "=== Error Output ==="
            echo "$ERROR" | sed 's/password[^[:space:]]*/[REDACTED]/gi' | sed 's/token[^[:space:]]*/[REDACTED]/gi' | sed 's/key[^[:space:]]*/[REDACTED]/gi' | sed 's/secret[^[:space:]]*/[REDACTED]/gi' | sed 's/Authorization[^[:space:]]*/[REDACTED]/gi'
          fi
          
          if [ "$STATUS" != "Success" ]; then
            echo "Deployment failed with status: $STATUS"
            exit 1
          fi
          
          echo "Deployment completed successfully"
