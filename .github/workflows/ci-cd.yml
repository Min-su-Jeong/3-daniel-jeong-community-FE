name: Node.js CI/CD

on:
  push:
    branches:
      - develop
  pull_request:
    branches:
      - develop

jobs:
  test:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        node-version: [19.x, 20.x, 21.x, 22.x]

    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}
      - name: Install dependencies
        run: npm install
      - name: Run tests
        run: npm test

  build-and-push-image:
    needs: test
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - uses: actions/checkout@v4
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Docker Hub Login
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_TOKEN }}
      - name: Build and Push Docker Image
        uses: docker/build-push-action@v5
        with:
          context: .
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/community-frontend:latest
          platforms: linux/arm64

  deploy:
    needs: build-and-push-image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/develop'

    steps:
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_DEFAULT_REGION }}

      - name: Get GitHub Actions IP Address
        id: get_ip
        run: |
          RUNNER_IP=$(curl -s https://api64.ipify.org)
          echo "runner_ip=$RUNNER_IP" >> $GITHUB_OUTPUT
          echo "GitHub Actions Runner IP: $RUNNER_IP"

      - name: Add GitHub Actions IP to EC2 Security Group
        run: |
          echo "Adding IP ${{ steps.get_ip.outputs.runner_ip }}/32 to Security Group ${{ secrets.SECURITY_GROUP_ID }}"
          OUTPUT=$(aws ec2 authorize-security-group-ingress \
            --group-id ${{ secrets.SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.get_ip.outputs.runner_ip }}/32 2>&1) || {
            EXIT_CODE=$?
            if echo "$OUTPUT" | grep -q "InvalidPermission.Duplicate\|already exists"; then
              echo "Rule already exists, continuing..."
            else
              echo "Failed to add Security Group rule: $OUTPUT"
              exit $EXIT_CODE
            fi
          }
          echo "$OUTPUT"

      - name: Verify Security Group Rule Added
        run: |
          echo "Verifying Security Group rule was added..."
          RULE_EXISTS=$(aws ec2 describe-security-groups \
            --group-ids ${{ secrets.SECURITY_GROUP_ID }} \
            --query "SecurityGroups[0].IpPermissions[?FromPort==\`22\` && ToPort==\`22\` && IpProtocol==\`tcp\`].IpRanges[?CidrIp==\`${{ steps.get_ip.outputs.runner_ip }}/32\`].CidrIp" \
            --output text)
          
          if [ -z "$RULE_EXISTS" ] || [ "$RULE_EXISTS" = "None" ] || [ "$RULE_EXISTS" = "" ]; then
            echo "Warning: Security Group rule not found in query, but this may be due to propagation delay. Continuing..."
          else
            echo "Security Group rule verified: $RULE_EXISTS"
          fi
          
      - name: Wait for Security Group Rule to Propagate
        run: |
          echo "Waiting 10 seconds for security group rule to propagate..."
          sleep 10

      - name: Prepare SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H ${{ secrets.SERVER_HOST }} >> ~/.ssh/known_hosts 2>/dev/null || echo "Warning: ssh-keyscan failed, but continuing..."

      - name: Test SSH Connection
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'echo "SSH connection successful"' || (echo "SSH connection failed" && exit 1)

      - name: Check if Docker is installed
        id: check-docker
        run: |
          DOCKER_EXISTS=$(ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'command -v docker >/dev/null && echo "true" || echo "false"')
          echo "docker_exists=$DOCKER_EXISTS" >> $GITHUB_OUTPUT

      - name: Check if Node.js is installed
        id: check-nodejs
        run: |
          NODE_EXISTS=$(ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} 'command -v node >/dev/null && echo "true" || echo "false"')
          echo "node_exists=$NODE_EXISTS" >> $GITHUB_OUTPUT

      - name: Install Docker on EC2
        if: steps.check-docker.outputs.docker_exists == 'false'
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'REMOTE_EOF'
            sudo apt-get update
            sudo apt-get install -y \
              ca-certificates \
              curl \
              gnupg \
              lsb-release
            sudo mkdir -p /etc/apt/keyrings
            curl -fsSL https://download.docker.com/linux/ubuntu/gpg \
              | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
            echo \
              "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] \
              https://download.docker.com/linux/ubuntu \
              $(lsb_release -cs) stable" \
              | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
            sudo apt-get update
            sudo apt-get install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
            sudo usermod -aG docker $USER
          REMOTE_EOF

      - name: Install Node.js on EC2
        if: steps.check-nodejs.outputs.node_exists == 'false'
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'REMOTE_EOF'
            curl -fsSL https://deb.nodesource.com/setup_lts.x | sudo -E bash -
            sudo apt-get install -y nodejs
          REMOTE_EOF

      - name: Check if Docker Network Exists
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'REMOTE_EOF'
            if ! sudo docker network inspect community-network >/dev/null 2>&1; then
              sudo docker network create community-network
              echo "Created docker network: community-network"
            else
              echo "Docker network community-network already exists"
            fi
          REMOTE_EOF

      - name: Deploy to EC2 via Docker Compose
        run: |
          ssh -i ~/.ssh/id_rsa -o StrictHostKeyChecking=no -o ConnectTimeout=10 ${{ secrets.SERVER_USER }}@${{ secrets.SERVER_HOST }} << 'REMOTE_EOF'
            cd /home/ubuntu/prod
            sudo docker compose pull frontend
            sudo docker compose up -d frontend
          REMOTE_EOF

      - name: Remove GitHub Actions IP from EC2 Security Group
        if: always()
        run: |
          echo "Removing GitHub Actions IP (${{ steps.get_ip.outputs.runner_ip }}) from Security Group..."
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ secrets.SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port 22 \
            --cidr ${{ steps.get_ip.outputs.runner_ip }}/32 || echo "Rule might not exist or already removed, continuing..."
